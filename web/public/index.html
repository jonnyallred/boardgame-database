<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Board Game Database - Image Upload</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 32px;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .stats {
      font-size: 18px;
      color: #6b7280;
    }

    .stats strong {
      color: #2563eb;
      font-size: 20px;
    }

    .search-bar {
      flex: 1;
      min-width: 250px;
      display: flex;
      gap: 10px;
    }

    .search-bar input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #2563eb;
    }

    /* Game Grid */
    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .game-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }
    }

    @media (max-width: 480px) {
      .game-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Game Card */
    .game-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }

    .game-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 16px rgba(0, 0, 0, 0.15);
    }

    .game-card.uploading {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Image Area */
    .image-area {
      position: relative;
      width: 100%;
      padding-bottom: 100%; /* 1:1 aspect ratio */
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
      overflow: hidden;
      transition: background-color 0.3s, border-color 0.3s;
    }

    .image-area img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-area.drag-over {
      background-color: #dbeafe;
      border-color: #2563eb;
    }

    .image-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #9ca3af;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    .image-placeholder svg {
      width: 40px;
      height: 40px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    @keyframes spin {
      to {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }

    .success-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(16, 185, 129, 0.2);
      animation: fadeOut 0.5s ease-out forwards;
      z-index: 5;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }

    /* Game Info */
    .game-info {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .game-name {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 6px;
      line-height: 1.3;
    }

    .game-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .game-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      flex: 1;
    }

    .tag {
      display: inline-block;
      background: #f0f4f8;
      color: #3b82f6;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .tag.style {
      background: #fef3c7;
      color: #d97706;
    }

    .tag.theme {
      background: #ede9fe;
      color: #7c3aed;
    }

    /* Action Buttons */
    .game-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-upload {
      background: #2563eb;
      color: white;
    }

    .btn-upload:hover {
      background: #1d4ed8;
    }

    .btn-upload:active {
      transform: scale(0.95);
    }

    input[type="file"] {
      display: none;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      pointer-events: none;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      pointer-events: auto;
      max-width: 400px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.success::before {
      content: 'âœ“';
      color: #10b981;
      font-weight: bold;
      font-size: 18px;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast.error::before {
      content: 'âœ•';
      color: #ef4444;
      font-weight: bold;
      font-size: 18px;
    }

    .toast-message {
      color: #374151;
      font-size: 14px;
      flex: 1;
    }

    /* Loading State */
    .loading-container {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner-large {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state h2 {
      color: #6b7280;
      margin-bottom: 10px;
    }

    /* Mobile adjustments */
    @media (max-width: 640px) {
      header {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }

      .header-info {
        flex-direction: column;
        align-items: stretch;
      }

      .search-bar {
        width: 100%;
      }

      .toast-container {
        left: 10px;
        right: 10px;
      }

      .toast {
        max-width: 100%;
      }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-container {
      background: white;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 10;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #6b7280;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      flex-shrink: 0;
    }

    .modal-close-btn:hover {
      color: #1f2937;
    }

    .modal-content {
      padding: 24px;
    }

    .modal-section {
      margin-bottom: 28px;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .modal-two-column {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 24px;
      align-items: start;
    }

    .modal-image {
      width: 200px;
      aspect-ratio: 1;
      background: #f3f4f6;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .modal-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    .modal-image-placeholder svg {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .modal-info-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-info-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modal-info-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .modal-info-value {
      font-size: 14px;
      color: #1f2937;
      line-height: 1.5;
    }

    .modal-description {
      font-size: 14px;
      color: #374151;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .rating-display {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .rating-label {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      min-width: 120px;
    }

    .rating-indicator {
      display: flex;
      gap: 6px;
    }

    .rating-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #e5e7eb;
      transition: background 0.2s;
    }

    .rating-dot.filled {
      background: #2563eb;
    }

    .rating-value {
      font-size: 13px;
      color: #6b7280;
      min-width: 180px;
    }

    .categories-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      display: inline-block;
      background: #f0f4f8;
      color: #3b82f6;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .tag.mechanic {
      background: #dbeafe;
      color: #1e40af;
    }

    .tag.style {
      background: #fef3c7;
      color: #92400e;
    }

    .tag.theme {
      background: #ede9fe;
      color: #5b21b6;
    }

    .tag.designer {
      background: #dcfce7;
      color: #166534;
    }

    .tag.publisher {
      background: #fee2e2;
      color: #991b1b;
    }

    .tag.evoke {
      background: #fff7ed;
      color: #c2410c;
      border: 1px solid #fed7aa;
    }

    .modal-list {
      font-size: 14px;
      color: #374151;
      line-height: 1.6;
    }

    .modal-list li {
      margin-bottom: 8px;
    }

    @media (max-width: 768px) {
      .modal-two-column {
        grid-template-columns: 1fr;
      }

      .modal-image {
        width: 100%;
      }

      .modal-header {
        padding: 16px;
      }

      .modal-content {
        padding: 16px;
      }

      .modal-title {
        font-size: 20px;
      }

      .rating-display {
        flex-direction: column;
        align-items: flex-start;
      }

      .rating-label {
        min-width: auto;
      }

      .rating-value {
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      .modal-overlay {
        padding: 10px;
      }

      .modal-container {
        max-height: 95vh;
      }

      .modal-title {
        font-size: 18px;
      }

      .rating-display {
        gap: 8px;
      }

      .rating-dot {
        width: 12px;
        height: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h1 style="margin:0">ðŸŽ² Board Game Database</h1>
        <nav style="display:flex;gap:4px;">
          <a href="/" style="padding:8px 14px;border-radius:6px;text-decoration:none;font-size:14px;font-weight:500;background:#2563eb;color:white;">Image Manager</a>
          <a href="/master-list" style="padding:8px 14px;border-radius:6px;text-decoration:none;font-size:14px;font-weight:500;color:#6b7280;">Master List</a>
        </nav>
      </div>
      <div class="header-info">
        <div class="stats">
          <strong id="images-count">0</strong> of <strong id="games-count">0</strong> games have images
        </div>
        <div class="search-bar">
          <input
            type="text"
            id="search-input"
            placeholder="Search games by name, designer, category..."
            aria-label="Search games"
          >
        </div>
      </div>
    </header>

    <!-- Game Grid -->
    <div id="game-grid" class="game-grid"></div>

    <!-- Loading State -->
    <div id="loading-state" class="loading-container" style="display: none;">
      <div class="loading-spinner-large"></div>
      <p>Loading games...</p>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state" style="display: none;">
      <h2>No games found</h2>
      <p>Try adjusting your search filters</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // State
    let allGames = [];
    let filteredGames = [];
    const uploadStates = new Map();
    let modalOpen = false;
    let currentModalGame = null;
    let currentEscHandler = null;

    // DOM Elements
    const gameGrid = document.getElementById('game-grid');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const searchInput = document.getElementById('search-input');
    const gamesCountEl = document.getElementById('games-count');
    const imagesCountEl = document.getElementById('images-count');
    const toastContainer = document.getElementById('toast-container');

    // Rating Labels
    const RATING_LABELS = {
      length: {
        0: 'Snack (10 min)',
        1: 'Appetizer (30 min)',
        2: 'Main Course (1 hr)',
        3: 'Feast (3 hrs)',
        4: 'Marathon (6+ hrs)'
      },
      rules_complexity: {
        0: 'Preschool (1 or 2 rules)',
        1: 'Elementary (basic instructions)',
        2: 'Junior High/High School (structured steps)',
        3: 'College (several complex mechanics)',
        4: 'PhD (intricate rules)'
      },
      strategic_depth: {
        0: 'Reflex (instant choices)',
        1: 'Basic (simple choices)',
        2: 'Tactics (short-term positioning)',
        3: 'Strategy (long-term planning)',
        4: 'Master Plan (multi-move optimization)'
      },
      feel: {
        0: 'Solitary (solo play)',
        1: 'Cooperative (work together)',
        2: 'Party (light social fun)',
        3: 'Polite (competitive minimal interaction)',
        4: 'Fierce (cutthroat rivalry)'
      },
      value: {
        0: 'Impulse (pocketable)',
        1: 'Bargain (filler chits)',
        2: 'Fair Deal (quality boards/cards)',
        3: 'Splurge (minis/tokens)',
        4: 'Heirloom (luxury production)'
      },
      affinity: {
        0: 'Loathe it',
        1: 'Yawn',
        2: 'Enjoyable',
        3: 'Delight',
        4: 'Mind-blowing'
      },
      hotness: {
        0: 'Will not play',
        1: 'Only if forced',
        2: 'Sure',
        3: 'Would love to play',
        4: 'Deep yearning'
      }
    };

    const RATING_NAMES = {
      length: 'Length',
      rules_complexity: 'Rules Complexity',
      strategic_depth: 'Strategic Depth',
      feel: 'Feel',
      value: 'Value',
      affinity: 'Affinity',
      hotness: 'Hotness'
    };

    const MECHANICS = [
      'Worker Placement', 'Deck Building', 'Engine Building', 'Area Control',
      'Tile Placement', 'Dice Rolling', 'Set Collection', 'Trick-taking',
      'Auctions/Bidding', 'Cooperative', '1 vs Many', 'Teams', 'Real-time',
      'Traitor', 'Social Deduction', 'Drafting', 'Press Your Luck', 'Roll & Write',
      'Hex Map', 'Campaign Mode', 'Legacy', 'Bag Building', 'Hand Management',
      'Modular Board', 'Variable Setup', 'Take That', 'Narrative Heavy',
      'Puzzle Solving', 'No Math', 'Word Play', 'Deduction', 'Racing',
      'Economic', 'Action Points', 'Route Building', 'Network Building',
      'Pattern Building', 'Resource Management', 'Trading', 'Negotiation',
      'Bluffing', 'Hidden Movement', 'Programmed Movement', 'Simultaneous Action',
      'Card Drafting', 'Tableau Building', 'Tech Tree', 'Rondel', 'Mancala', 'Dexterity'
    ];

    const STYLES = [
      'Euro', 'Ameritrash', 'Abstract', 'Party', 'Family', 'Wargame',
      'Filler', 'Gateway', 'Cult Classic', 'Dungeon Crawler', '4X', 'Dudes on a Map'
    ];

    const THEMES = [
      'Fantasy', 'Sci-Fi', 'Horror', 'Historical', 'Western', 'Pirates', 'Zombies',
      'Vampires', 'Cthulhu', 'Aliens', 'Post-Apocalyptic', 'Superheroes', 'Marvel',
      'Disney', 'Lord of the Rings', 'Animals', 'Food Theme', 'Time Travel', 'Space',
      'Medieval', 'Ancient', 'Mythology', 'Nature', 'City Building', 'Civilization',
      'War', 'Survival', 'Mystery', 'Espionage', 'Steampunk', 'Cyberpunk',
      'Aviation', 'Maritime', 'Trains', 'Agriculture'
    ];

    const DESIGNERS = [
      'Reiner Knizia', 'Uwe Rosenberg', 'Vlaada Chvatil', 'Stefan Feld',
      'Martin Wallace', 'Eric Lang', 'Jamey Stegmaier', 'Cole Wehrle',
      'Corey Konieczka', 'Bruno Cathala', 'Antoine Bauza', 'Wolfgang Kramer',
      'Michael Kiesling', 'Alexander Pfister', 'Vital Lacerda', 'Matt Leacock',
      'Rob Daviau', 'Richard Garfield', 'Klaus Teuber', 'Alan R. Moon',
      'Donald X. Vaccarino', 'Isaac Childres', 'Simone Luciani', 'Daniele Tascini',
      'Phil Walker-Harding', 'Friedemann Friese', 'Mac Gerdts', 'Carl Chudyk'
    ];

    const PUBLISHERS = [
      'Stonemaier Games', 'Fantasy Flight Games', 'Leder Games', 'CMON',
      'Days of Wonder', 'Chip Theory Games', 'Restoration Games', 'Z-Man Games',
      'Rio Grande Games', 'Ravensburger', 'Asmodee', 'Cephalofair Games',
      'Roxley Games', 'Renegade Game Studios', 'Capstone Games', 'Eagle-Gryphon Games',
      'Czech Games Edition', 'Portal Games', 'Plaid Hat Games', 'Red Raven Games',
      'Osprey Games', 'Greater Than Games'
    ];

    // ============ Helper Functions ============

    function getCategoryType(category) {
      if (MECHANICS.includes(category)) return 'mechanic';
      if (STYLES.includes(category)) return 'style';
      if (THEMES.includes(category)) return 'theme';
      if (DESIGNERS.includes(category)) return 'designer';
      if (PUBLISHERS.includes(category)) return 'publisher';
      return 'mechanic';
    }

    function createRatingIndicator(value) {
      const html = document.createElement('div');
      html.className = 'rating-indicator';

      for (let i = 0; i < 4; i++) {
        const dot = document.createElement('div');
        dot.className = 'rating-dot';
        if (i < value) {
          dot.classList.add('filled');
        }
        html.appendChild(dot);
      }

      return html;
    }

    function formatPlayerCounts(possibleCounts, trueCounts) {
      if (!possibleCounts || possibleCounts.length === 0) return 'Unknown';

      let result = possibleCounts.join(', ') + ' players';

      if (trueCounts && trueCounts.length > 0) {
        result += ` (best: ${trueCounts.join(', ')})`;
      }

      return result;
    }

    function formatPlaytime(playtimeMinutes, minPlaytime, maxPlaytime) {
      let result = '';

      if (playtimeMinutes) {
        result = `${playtimeMinutes} min`;
      }

      if (minPlaytime && maxPlaytime) {
        const range = `${minPlaytime}-${maxPlaytime} min`;
        result = result ? `${result} (${range})` : range;
      }

      return result || 'Not specified';
    }

    function buildRatingDisplay(name, value) {
      const div = document.createElement('div');
      div.className = 'rating-display';

      const label = document.createElement('div');
      label.className = 'rating-label';
      label.textContent = RATING_NAMES[name];

      const indicatorContainer = document.createElement('div');
      indicatorContainer.style.display = 'flex';
      indicatorContainer.style.alignItems = 'center';
      indicatorContainer.style.gap = '12px';
      indicatorContainer.style.flex = '1';

      if (value === null || value === undefined) {
        const notRated = document.createElement('div');
        notRated.className = 'rating-value';
        notRated.textContent = 'Not Rated';
        indicatorContainer.appendChild(notRated);
      } else {
        const valueNum = Math.min(Math.max(0, parseInt(value)), 4);
        const indicator = createRatingIndicator(valueNum);
        indicatorContainer.appendChild(indicator);

        const ratingText = document.createElement('div');
        ratingText.className = 'rating-value';
        ratingText.textContent = `${valueNum} - ${RATING_LABELS[name][valueNum]}`;
        indicatorContainer.appendChild(ratingText);
      }

      div.appendChild(label);
      div.appendChild(indicatorContainer);
      return div;
    }

    // ============ Modal Functions ============

    function buildModalHTML(game) {
      const div = document.createElement('div');
      div.className = 'modal-overlay';
      div.setAttribute('role', 'dialog');
      div.setAttribute('aria-modal', 'true');
      div.setAttribute('aria-labelledby', 'modal-title');

      const container = document.createElement('div');
      container.className = 'modal-container';

      // Header
      const header = document.createElement('div');
      header.className = 'modal-header';

      const title = document.createElement('h2');
      title.id = 'modal-title';
      title.className = 'modal-title';
      title.textContent = `${game.name} (${game.year})`;

      const closeBtn = document.createElement('button');
      closeBtn.className = 'modal-close-btn';
      closeBtn.setAttribute('aria-label', 'Close modal');
      closeBtn.innerHTML = 'Ã—';
      closeBtn.addEventListener('click', closeGameModal);

      header.appendChild(title);
      header.appendChild(closeBtn);

      // Content
      const content = document.createElement('div');
      content.className = 'modal-content';

      // Image + Info Section
      const imageInfoSection = document.createElement('div');
      imageInfoSection.className = 'modal-section';

      const imageInfoDiv = document.createElement('div');
      imageInfoDiv.className = 'modal-two-column';

      // Image
      const imageDiv = document.createElement('div');
      imageDiv.className = 'modal-image';

      if (game.has_image) {
        const img = document.createElement('img');
        img.src = `/api/images/${encodeURIComponent(game.name)} (${game.year}).jpg`;
        img.alt = game.name;
        let attemptCount = 0;
        img.onerror = () => {
          attemptCount++;
          if (attemptCount === 1) {
            // Try PNG if JPG fails
            img.src = `/api/images/${encodeURIComponent(game.name)} (${game.year}).png`;
          } else if (attemptCount === 2) {
            // Try WEBP if PNG fails
            img.src = `/api/images/${encodeURIComponent(game.name)} (${game.year}).webp`;
          } else {
            // If all fail, show placeholder
            imageDiv.innerHTML = `
              <div class="modal-image-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5L5 21"/>
                </svg>
                <div>Image not found</div>
              </div>
            `;
          }
        };
        imageDiv.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'modal-image-placeholder';
        placeholder.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <path d="M21 15l-5-5L5 21"/>
          </svg>
          <div>No image available</div>
        `;
        imageDiv.appendChild(placeholder);
      }

      // Info Grid
      const infoGrid = document.createElement('div');
      infoGrid.className = 'modal-info-grid';

      // Designers
      if (game.designer && game.designer.length > 0) {
        const row = document.createElement('div');
        row.className = 'modal-info-row';
        const label = document.createElement('div');
        label.className = 'modal-info-label';
        label.textContent = 'Designers';
        const value = document.createElement('div');
        value.className = 'modal-info-value';
        value.textContent = game.designer.join(', ');
        row.appendChild(label);
        row.appendChild(value);
        infoGrid.appendChild(row);
      }

      // Publishers
      if (game.publisher && game.publisher.length > 0) {
        const row = document.createElement('div');
        row.className = 'modal-info-row';
        const label = document.createElement('div');
        label.className = 'modal-info-label';
        label.textContent = 'Publishers';
        const value = document.createElement('div');
        value.className = 'modal-info-value';
        value.textContent = game.publisher.join(', ');
        row.appendChild(label);
        row.appendChild(value);
        infoGrid.appendChild(row);
      }

      // Playtime
      const playtime = formatPlaytime(game.playtime_minutes, game.min_playtime, game.max_playtime);
      const playtimeRow = document.createElement('div');
      playtimeRow.className = 'modal-info-row';
      const playtimeLabel = document.createElement('div');
      playtimeLabel.className = 'modal-info-label';
      playtimeLabel.textContent = 'Playtime';
      const playtimeValue = document.createElement('div');
      playtimeValue.className = 'modal-info-value';
      playtimeValue.textContent = playtime;
      playtimeRow.appendChild(playtimeLabel);
      playtimeRow.appendChild(playtimeValue);
      infoGrid.appendChild(playtimeRow);

      // Min Age
      if (game.min_age !== null && game.min_age !== undefined) {
        const row = document.createElement('div');
        row.className = 'modal-info-row';
        const label = document.createElement('div');
        label.className = 'modal-info-label';
        label.textContent = 'Min Age';
        const value = document.createElement('div');
        value.className = 'modal-info-value';
        value.textContent = `${game.min_age}+`;
        row.appendChild(label);
        row.appendChild(value);
        infoGrid.appendChild(row);
      }

      // Player Counts
      const playerCounts = formatPlayerCounts(game.possible_counts, game.true_counts);
      const playerRow = document.createElement('div');
      playerRow.className = 'modal-info-row';
      const playerLabel = document.createElement('div');
      playerLabel.className = 'modal-info-label';
      playerLabel.textContent = 'Players';
      const playerValue = document.createElement('div');
      playerValue.className = 'modal-info-value';
      playerValue.textContent = playerCounts;
      playerRow.appendChild(playerLabel);
      playerRow.appendChild(playerValue);
      infoGrid.appendChild(playerRow);

      imageInfoDiv.appendChild(imageDiv);
      imageInfoDiv.appendChild(infoGrid);
      imageInfoSection.appendChild(imageInfoDiv);
      content.appendChild(imageInfoSection);

      // Description
      if (game.description) {
        const descSection = document.createElement('div');
        descSection.className = 'modal-section';

        const descTitle = document.createElement('div');
        descTitle.className = 'modal-section-title';
        descTitle.textContent = 'Description';

        const descText = document.createElement('p');
        descText.className = 'modal-description';
        descText.textContent = game.description;

        descSection.appendChild(descTitle);
        descSection.appendChild(descText);
        content.appendChild(descSection);
      }

      // Ratings
      const ratingsSection = document.createElement('div');
      ratingsSection.className = 'modal-section';

      const ratingsTitle = document.createElement('div');
      ratingsTitle.className = 'modal-section-title';
      ratingsTitle.textContent = 'Ratings';

      ratingsSection.appendChild(ratingsTitle);

      const ratingFields = ['length', 'rules_complexity', 'strategic_depth', 'feel', 'value', 'affinity', 'hotness'];
      ratingFields.forEach(field => {
        const rating = buildRatingDisplay(field, game[field]);
        ratingsSection.appendChild(rating);
      });

      content.appendChild(ratingsSection);

      // Categories
      if (game.categories && game.categories.length > 0) {
        const catSection = document.createElement('div');
        catSection.className = 'modal-section';

        const catTitle = document.createElement('div');
        catTitle.className = 'modal-section-title';
        catTitle.textContent = 'Categories';

        const catGrid = document.createElement('div');
        catGrid.className = 'categories-grid';

        game.categories.forEach(cat => {
          const tag = document.createElement('span');
          tag.className = `tag ${getCategoryType(cat)}`;
          tag.textContent = cat;
          catGrid.appendChild(tag);
        });

        catSection.appendChild(catTitle);
        catSection.appendChild(catGrid);
        content.appendChild(catSection);
      }

      // Evokes
      if (game.evokes && game.evokes.length > 0) {
        const evokeSection = document.createElement('div');
        evokeSection.className = 'modal-section';

        const evokeTitle = document.createElement('div');
        evokeTitle.className = 'modal-section-title';
        evokeTitle.textContent = 'Evokes';

        const evokeGrid = document.createElement('div');
        evokeGrid.className = 'categories-grid';

        game.evokes.forEach(evoke => {
          const tag = document.createElement('span');
          tag.className = 'tag evoke';
          tag.textContent = evoke;
          evokeGrid.appendChild(tag);
        });

        evokeSection.appendChild(evokeTitle);
        evokeSection.appendChild(evokeGrid);
        content.appendChild(evokeSection);
      }

      // Additional Details
      const hasAdditionalDetails =
        game.game_family ||
        game.edition ||
        (game.expansions && game.expansions.length > 0) ||
        (game.compatible_with && game.compatible_with.length > 0) ||
        (game.upgrades && game.upgrades.length > 0);

      if (hasAdditionalDetails) {
        const addlSection = document.createElement('div');
        addlSection.className = 'modal-section';

        const addlTitle = document.createElement('div');
        addlTitle.className = 'modal-section-title';
        addlTitle.textContent = 'Additional Details';

        if (game.game_family) {
          const row = document.createElement('div');
          row.className = 'modal-info-row';
          const label = document.createElement('div');
          label.className = 'modal-info-label';
          label.textContent = 'Game Family';
          const value = document.createElement('div');
          value.className = 'modal-info-value';
          value.textContent = game.game_family;
          row.appendChild(label);
          row.appendChild(value);
          addlSection.appendChild(row);
        }

        if (game.edition) {
          const row = document.createElement('div');
          row.className = 'modal-info-row';
          const label = document.createElement('div');
          label.className = 'modal-info-label';
          label.textContent = 'Edition';
          const value = document.createElement('div');
          value.className = 'modal-info-value';
          value.textContent = game.edition;
          row.appendChild(label);
          row.appendChild(value);
          addlSection.appendChild(row);
        }

        if (game.expansions && game.expansions.length > 0) {
          const row = document.createElement('div');
          row.className = 'modal-info-row';
          const label = document.createElement('div');
          label.className = 'modal-info-label';
          label.textContent = 'Expansions';
          const value = document.createElement('div');
          value.className = 'modal-info-value';
          value.textContent = game.expansions.join(', ');
          row.appendChild(label);
          row.appendChild(value);
          addlSection.appendChild(row);
        }

        if (game.compatible_with && game.compatible_with.length > 0) {
          const row = document.createElement('div');
          row.className = 'modal-info-row';
          const label = document.createElement('div');
          label.className = 'modal-info-label';
          label.textContent = 'Compatible With';
          const value = document.createElement('div');
          value.className = 'modal-info-value';
          value.textContent = game.compatible_with.join(', ');
          row.appendChild(label);
          row.appendChild(value);
          addlSection.appendChild(row);
        }

        if (game.upgrades && game.upgrades.length > 0) {
          const row = document.createElement('div');
          row.className = 'modal-info-row';
          const label = document.createElement('div');
          label.className = 'modal-info-label';
          label.textContent = 'Upgrades';
          const value = document.createElement('div');
          value.className = 'modal-info-value';
          const upgradeList = game.upgrades.map(u => u.name || u).join(', ');
          value.textContent = upgradeList;
          row.appendChild(label);
          row.appendChild(value);
          addlSection.appendChild(row);
        }

        content.appendChild(addlSection);
      }

      container.appendChild(header);
      container.appendChild(content);
      div.appendChild(container);

      return div;
    }

    function openGameModal(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (!game) return;

      currentModalGame = game;
      modalOpen = true;

      const modal = buildModalHTML(game);
      document.body.appendChild(modal);

      // Prevent body scroll
      document.body.style.overflow = 'hidden';

      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeGameModal();
        }
      });

      // Close on ESC key
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          closeGameModal();
        }
      };
      document.addEventListener('keydown', handleEsc);

      // Store handler reference for cleanup
      currentEscHandler = handleEsc;
    }

    function closeGameModal() {
      if (!modalOpen) return;

      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        // Remove ESC key handler
        if (currentEscHandler) {
          document.removeEventListener('keydown', currentEscHandler);
          currentEscHandler = null;
        }

        modal.style.animation = 'fadeOut 0.2s ease-out forwards';
        setTimeout(() => {
          modal.remove();
          modalOpen = false;
          currentModalGame = null;
          document.body.style.overflow = 'auto';
        }, 200);
      }
    }

    // ============ Initialization ============

    async function init() {
      try {
        loadingState.style.display = 'block';
        await loadGames();
        setupEventListeners();
        updateStats();
        renderGames();
        loadingState.style.display = 'none';
      } catch (error) {
        console.error('Failed to initialize:', error);
        showToast('Failed to load games', 'error');
        loadingState.style.display = 'none';
      }
    }

    // ============ Data Loading ============

    async function loadGames() {
      const response = await fetch('/api/games');
      if (!response.ok) {
        throw new Error('Failed to load games');
      }
      allGames = await response.json();
      filteredGames = [...allGames];
    }

    // ============ Event Listeners ============

    function setupEventListeners() {
      searchInput.addEventListener('input', handleSearch);
    }

    function handleSearch(e) {
      const query = e.target.value.toLowerCase();

      filteredGames = allGames.filter(game => {
        const searchableText = [
          game.name,
          ...(game.designer || []),
          ...(game.publisher || []),
          ...(game.categories || []),
          ...(game.evokes || [])
        ]
          .join(' ')
          .toLowerCase();

        return searchableText.includes(query);
      });

      renderGames();
    }

    // ============ Rendering ============

    function renderGames() {
      gameGrid.innerHTML = '';

      if (filteredGames.length === 0) {
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      filteredGames.forEach(game => {
        const card = createGameCard(game);
        gameGrid.appendChild(card);
      });
    }

    function createGameCard(game) {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.dataset.gameId = game.id;

      // Add click handler to open modal
      card.addEventListener('click', (e) => {
        if (e.target.closest('.game-actions')) return;
        openGameModal(game.id);
      });

      // Image area
      const imageArea = document.createElement('div');
      imageArea.className = 'image-area';

      if (game.has_image) {
        const img = document.createElement('img');
        img.src = `/api/images/${encodeURIComponent(game.name)} (${game.year}).jpg`;
        img.alt = game.name;
        img.onerror = () => {
          // Try PNG if JPG fails
          img.src = `/api/images/${encodeURIComponent(game.name)} (${game.year}).png`;
        };
        imageArea.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'image-placeholder';
        placeholder.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <path d="M21 15l-5-5L5 21"/>
          </svg>
          <div>Drop image here or click to upload</div>
        `;
        imageArea.appendChild(placeholder);
      }

      // Drag and drop events
      setupDragAndDrop(imageArea, game.id);

      // Game info
      const info = document.createElement('div');
      info.className = 'game-info';

      const name = document.createElement('div');
      name.className = 'game-name';
      name.textContent = game.name;

      const meta = document.createElement('div');
      meta.className = 'game-meta';
      const designers = game.designer && game.designer.length ? game.designer.join(', ') : 'Unknown';
      meta.textContent = `${designers} â€¢ ${game.year}`;

      const categories = document.createElement('div');
      categories.className = 'game-categories';
      (game.categories || []).slice(0, 3).forEach(cat => {
        const tag = document.createElement('span');
        tag.className = 'tag';

        // Add style class for different category types
        if (['Euro', 'Ameritrash', 'Abstract', 'Party', 'Family'].includes(cat)) {
          tag.classList.add('style');
        } else if (['Fantasy', 'Sci-Fi', 'Horror', 'Historical', 'Mystery'].includes(cat)) {
          tag.classList.add('theme');
        }

        tag.textContent = cat;
        categories.appendChild(tag);
      });

      const evokes = document.createElement('div');
      evokes.className = 'game-categories';
      (game.evokes || []).forEach(evoke => {
        const tag = document.createElement('span');
        tag.className = 'tag evoke';
        tag.textContent = evoke;
        evokes.appendChild(tag);
      });

      const actions = document.createElement('div');
      actions.className = 'game-actions';
      const uploadBtn = document.createElement('button');
      uploadBtn.className = 'btn btn-upload';
      uploadBtn.textContent = 'Upload Image';
      uploadBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        triggerFileInput(game.id);
      });

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.addEventListener('change', (e) => handleFileSelect(e, game.id));

      info.appendChild(name);
      info.appendChild(meta);
      info.appendChild(categories);
      info.appendChild(evokes);
      info.appendChild(actions);
      actions.appendChild(uploadBtn);
      info.appendChild(fileInput);

      card.appendChild(imageArea);
      card.appendChild(info);

      return card;
    }

    function setupDragAndDrop(imageArea, gameId) {
      imageArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        imageArea.classList.add('drag-over');
      });

      imageArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        imageArea.classList.remove('drag-over');
      });

      imageArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        imageArea.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect({ target: { files } }, gameId);
        }
      });
    }

    function triggerFileInput(gameId) {
      const card = gameGrid.querySelector(`[data-game-id="${gameId}"]`);
      const fileInput = card.querySelector('input[type="file"]');
      fileInput.click();
    }

    async function handleFileSelect(e, gameId) {
      const files = e.target.files;
      if (files.length === 0) return;

      const file = files[0];

      // Validate file type client-side
      if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }

      // Validate file size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        showToast('File is too large. Maximum 10MB allowed.', 'error');
        return;
      }

      await uploadImage(gameId, file);
    }

    async function uploadImage(gameId, file) {
      const card = gameGrid.querySelector(`[data-game-id="${gameId}"]`);
      const imageArea = card.querySelector('.image-area');

      try {
        // Show loading state
        card.classList.add('uploading');
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        imageArea.appendChild(spinner);

        // Upload file
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch(`/api/games/${gameId}/upload`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Upload failed');
        }

        const result = await response.json();

        // Show success animation
        const overlay = document.createElement('div');
        overlay.className = 'success-overlay';
        imageArea.appendChild(overlay);

        // Reload the games to get updated image status
        await loadGames();
        renderGames();

        showToast(`Image uploaded successfully!`, 'success');
        updateStats();
      } catch (error) {
        console.error('Upload error:', error);
        showToast(error.message || 'Failed to upload image', 'error');
      } finally {
        card.classList.remove('uploading');
        const spinner = imageArea.querySelector('.loading-spinner');
        if (spinner) spinner.remove();
      }
    }

    // ============ Utilities ============

    function updateStats() {
      const totalGames = allGames.length;
      const gamesWithImages = allGames.filter(g => g.has_image).length;

      gamesCountEl.textContent = totalGames;
      imagesCountEl.textContent = gamesWithImages;
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<div class="toast-message">${message}</div>`;

      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ============ Start ============

    init();
  </script>
</body>
</html>
